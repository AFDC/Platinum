- include_shirt_size = (@league.created_at > Date.new(2019, 4, 11))
- headers = %w(user_id pair_id draft_id team_id status official_rank)
- headers << "self_rank" if @league.self_rank_type == 'simple'
- headers.push(*%w(exp_rank ath_rank skl_rank)) if @league.self_rank_type == "detailed"
- headers.push(*%w(firstname lastname pronouns email matchup covid_vax availability notes birthdate height EOST))
- if include_shirt_size
    - headers << 'shirt_size'
= headers.join(',')
- @registrations.each do |reg_item|
    - if reg_item.is_a? Registration
        - r = reg_item
    - else
        - r = Registraiton.find(reg_item)
    - next unless r
    - reg_vax = ""
    - reg_vax << "V" if r.user.confirmed_covid_vax
    - reg_vax << "B" if r.user.confirmed_covid_booster
    - row = []
    - row << r.user_id
    - row << (Digest::MD5.hexdigest [r.user_id, r.pair_id].sort.join('_') if r.pair)
    - row << nil
    - row << r.league.team_for(r.user).try(:_id)
    - row << r.status
    - row << r.rank
    - if @league.self_rank_type == "simple"
        - row << r.self_rank
    - if @league.self_rank_type == "detailed"
        - if r.detailed_self_rank.present?
            - row << r.detailed_self_rank["experience"]
            - row << r.detailed_self_rank["athleticism"]
            - row << r.detailed_self_rank["skills"]
        - else
            - row << ""
            - row << ""
            - row << ""
    - row << r.user_data['firstname']
    - row << r.user_data['lastname']
    - row << r.user.pronouns.display
    - row << r.user.email_address
    - row << r.gender_noun
    - row << reg_vax
    - row << r.gen_availability
    - row << r.notes
    - row << r.user.age
    - row << r.user_data['height']
    - row << r.eos_availability
    - if include_shirt_size
        - row << r.shirt_size
    = raw row.to_csv(row_sep: nil)
